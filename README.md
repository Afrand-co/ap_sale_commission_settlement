# AP Sale Commission Settlement Enhancement

## ๐ ูุนุฑู

ูุงฺูู **AP Sale Commission Settlement Enhancement** ฺฉ ุงูุฒููู ุจุฑุง ูุงฺูู `commission` ุฏุฑ Odoo 17 ุงุณุช ฺฉู ููุฏูุง "ูุงฺฉุชูุฑ ูุฑุชุจุท" ู "ุฎุฑุฏุงุฑ" ุฑุง ุจู ููุง ูุณุช ู ูุฑู ุชุณููโูุง ฺฉูุณูู ู ุฎุทูุท ฺฉูุณูู ุงุถุงูู ูโฺฉูุฏ.

ุงู ูุงฺูู ุจู ุดูุง ุงูฺฉุงู ูโุฏูุฏ ุจู ุฑุงุญุช ูุงฺฉุชูุฑ ูุฑุชุจุท ุจุง ูุฑ ุชุณูู ฺฉูุณูู ู ุงุทูุงุนุงุช ุฎุฑุฏุงุฑ ุฑุง ุฏุฑ ูุณุช ุชุณููโูุง ูุดุงูุฏู ฺฉูุฏ.

---

## โจ ูฺฺฏโูุง

### ุจุฑุง ูุฏู `commission.settlement`:
- โ ููุฏ **ูุงฺฉุชูุฑ ูุฑุชุจุท** (`invoice_id`) - ููุงุด ุงููู ูุงฺฉุชูุฑ ูุฑุชุจุท
- โ ููุฏ **ูุงฺฉุชูุฑูุง ูุฑุชุจุท** (`invoice_ids`) - ููุงุด ุชูุงู ูุงฺฉุชูุฑูุง ูุฑุชุจุท
- โ ููุฏ **ุฎุฑุฏุงุฑ** (`partner_id`) - ููุงุด ุฎุฑุฏุงุฑ ุงุฒ ูุงฺฉุชูุฑ ูุฑุชุจุท
- โ ููุงุด ููุฏูุง ุฏุฑ Tree View ู Form View

### ุจุฑุง ูุฏู `commission.settlement.line`:
- โ ููุฏ **ูุงฺฉุชูุฑ ูุฑุชุจุท** (`invoice_id`) - ูุญุงุณุจู ุดุฏู ุจุฑุง ูุฑ ุฎุท
- โ ููุฏ **ุฎุฑุฏุงุฑ** (`partner_id`) - ูุญุงุณุจู ุดุฏู ุงุฒ ูุงฺฉุชูุฑ
- โ ููุงุด ููุฏูุง ุฏุฑ Tree View ู Form View

---

## ๐ ูุตุจ

### ุฑูุด 1: ุงุฒ ุทุฑู UI

1. ูุงูโูุง ูุงฺูู ุฑุง ุฏุฑ ูุณุฑ `addons/ap_sale_commission_settlement/` ูุฑุงุฑ ุฏูุฏ
2. Odoo ุฑุง ุฑโุงุณุชุงุฑุช ฺฉูุฏ:
   ```bash
   sudo systemctl restart odoo
   ```
3. ุจู **Settings > Apps** ุจุฑูุฏ
4. **Update Apps List** ุฑุง ฺฉูฺฉ ฺฉูุฏ
5. ูุงฺูู **"AP Sale Commission Settlement Enhancement"** ุฑุง ุฌุณุชุฌู ฺฉูุฏ
6. ุฑู **Install** ฺฉูฺฉ ฺฉูุฏ

### ุฑูุด 2: ุงุฒ ุทุฑู Command Line

```bash
# 1. ฺฉูพ ฺฉุฑุฏู ูุงูโูุง ุฏุฑ ูุณุฑ addons
cp -r ap_sale_commission_settlement /path/to/odoo/addons/

# 2. ุชูุธู ุฏุณุชุฑุณโูุง
sudo chown -R odoo:odoo /path/to/odoo/addons/ap_sale_commission_settlement
sudo chmod -R 755 /path/to/odoo/addons/ap_sale_commission_settlement

# 3. Restart Odoo
sudo systemctl restart odoo

# 4. ูุตุจ ุงุฒ ุทุฑู Odoo UI ุง command line
```

---

## ๐ ุงุณุชูุงุฏู

### ุฏุณุชุฑุณ ุจู ุชุณููโูุง ฺฉูุณูู

1. ุจู **Sales > Commissions > Settlements** ุจุฑูุฏ
2. ุฏุฑ ูุณุช ุชุณููโูุงุ ุณุชููโูุง ุฌุฏุฏ ุฑุง ูุดุงูุฏู ุฎูุงูุฏ ฺฉุฑุฏ:
   - **ุฎุฑุฏุงุฑ** (Partner)
   - **ูุงฺฉุชูุฑ ูุฑุชุจุท** (Related Invoice)
3. ุจุง ฺฉูฺฉ ุฑู ูุงฺฉุชูุฑุ ูโุชูุงูุฏ ุจู ูุงฺฉุชูุฑ ูุฑุชุจุท ุจุฑูุฏ

### ุฏุณุชุฑุณ ุจู ุฎุทูุท ฺฉูุณูู

1. ุฏุฑ ูุฑ ุชุณููุ ุจู ุชุจ **Lines** ุจุฑูุฏ
2. ุฏุฑ ูุณุช ุฎุทูุทุ ุณุชููโูุง ุฌุฏุฏ ุฑุง ูุดุงูุฏู ุฎูุงูุฏ ฺฉุฑุฏ:
   - **ุฎุฑุฏุงุฑ** (Partner)
   - **ูุงฺฉุชูุฑ ูุฑุชุจุท** (Related Invoice)

---

## ๐ ุณุงุฎุชุงุฑ ูุงูโูุง

```
ap_sale_commission_settlement/
โโโ __init__.py                          # Import models
โโโ __manifest__.py                      # Module manifest
โโโ README.md                            # ุงู ูุงู
โโโ models/
โ   โโโ __init__.py                      # Import models
โ   โโโ commission_settlement.py        # Extend commission.settlement
โ   โโโ commission_settlement_line.py    # Extend commission.settlement.line
โโโ views/
    โโโ commission_settlement_views.xml  # View definitions
```

---

## ๐ง ุชูุถุญุงุช ูู

### ูุฏู `commission.settlement`

#### ููุฏูุง:

1. **`invoice_id`** (Many2one)
   - ููุน: `account.move`
   - ูุญุงุณุจู: ุงุฒ `line_ids` ูุญุงุณุจู ูโุดูุฏ
   - ุฐุฎุฑู: ุจูู (`store=True`)
   - ููุท ุฎูุงูุฏู: ุจูู

2. **`invoice_ids`** (Many2many)
   - ููุน: `account.move`
   - ูุญุงุณุจู: ุชูุงู ูุงฺฉุชูุฑูุง ูุฑุชุจุท ุงุฒ `line_ids`
   - ุฐุฎุฑู: ุจูู (`store=True`)

3. **`partner_id`** (Many2one)
   - ููุน: `res.partner`
   - ูุญุงุณุจู: ุงุฒ `invoice_id.partner_id`
   - ุฐุฎุฑู: ุจูู (`store=True`)
   - ููุท ุฎูุงูุฏู: ุจูู

#### ูุชุฏูุง ูุญุงุณุจู:

**`_compute_invoice_id`**: ุงู ูุชุฏ ุจุง ุณู ุฑูุด ูุฎุชูู ุณุน ูโฺฉูุฏ ูุงฺฉุชูุฑ ุฑุง ูพุฏุง ฺฉูุฏ:
1. ุงุฒ `invoice_line_id` ุฏุฑ ุฎุทูุท ุชุณูู
2. ุงุฒ `object_id.invoice_ids` (Sale Order)
3. ุงุฒ `invoice_id` ูุณุชูู ุฏุฑ ุฎุท

**`_compute_partner_id`**: ุงุฒ `invoice_id.partner_id` ูุญุงุณุจู ูโุดูุฏ.

### ูุฏู `commission.settlement.line`

#### ููุฏูุง:

1. **`invoice_id`** (Many2one)
   - ููุน: `account.move`
   - ูุญุงุณุจู: ุงุฒ ููุฏูุง ููุฌูุฏ ุฏุฑ ุฎุท
   - ุฐุฎุฑู: ุฎุฑ (`store=False`) - ุจุฑุง ุณุงุฒฺฏุงุฑ ุจุง ุณุงุฎุชุงุฑูุง ูุฎุชูู
   - ููุท ุฎูุงูุฏู: ุจูู

2. **`partner_id`** (Many2one)
   - ููุน: `res.partner`
   - ูุญุงุณุจู: ุงุฒ `invoice_id.partner_id`
   - ุฐุฎุฑู: ุฎุฑ (`store=False`)
   - ููุท ุฎูุงูุฏู: ุจูู

#### ูุชุฏูุง ูุญุงุณุจู:

**`_compute_invoice_id`**: ุงู ูุชุฏ ุจุง ฺูุงุฑ ุฑูุด ูุฎุชูู ุณุน ูโฺฉูุฏ ูุงฺฉุชูุฑ ุฑุง ูพุฏุง ฺฉูุฏ:
1. ุงุฒ `invoice_line_id` ูุณุชูู
2. ุงุฒ `object_id` (Sale Order) ู ุณูพุณ `invoice_ids`
3. ุงุฒ `invoice_id` ูุณุชูู ุฏุฑ ุฎุท
4. ุงุฒ `settlement_id` ู ุฎุทูุท ุฏฺฏุฑ (ุขูุงุฏู ุจุฑุง ุชูุณุนู)

**`_compute_partner_id`**: ุงุฒ `invoice_id.partner_id` ูุญุงุณุจู ูโุดูุฏ.

### View ูุง

#### Tree View ุจุฑุง `commission.settlement.line`:
- ููุงุด ููุฏูุง: `settlement_id`, `agent_id`, `partner_id`, `invoice_id`, `settled_amount`
- ููุฏูุง `partner_id` ู `invoice_id` ุจุง `optional="show"` ูุณุชูุฏ (ูุงุจู ููุงุด/ูุฎู)

#### Form View ุจุฑุง `commission.settlement.line`:
- ุณุงุฎุชุงุฑ ุณุงุฏู ุจุง ฺฏุฑููโุจูุฏ
- ููุฏูุง `partner_id` ู `invoice_id` ููุท ุฎูุงูุฏู ูุณุชูุฏ
- ุณุงุฒฺฏุงุฑ ุจุง Odoo Studio

---

## ๐ ููุทู ูุญุงุณุจู ูุงฺฉุชูุฑ

ูุงฺูู ุงุฒ ุฑูุดโูุง ูุฎุชูู ุจุฑุง ุงูุชู ูุงฺฉุชูุฑ ูุฑุชุจุท ุงุณุชูุงุฏู ูโฺฉูุฏ ุชุง ุจุง ุณุงุฎุชุงุฑูุง ูุฎุชูู ูุงฺูู `commission` ุณุงุฒฺฏุงุฑ ุจุงุดุฏ:

### ุฑูุด 1: ุงุฒ `invoice_line_id`
```python
if hasattr(line, 'invoice_line_id') and line.invoice_line_id:
    invoice = line.invoice_line_id.move_id
```

### ุฑูุด 2: ุงุฒ Sale Order
```python
if hasattr(line, 'object_id') and line.object_id:
    if line.object_id._name == 'sale.order':
        invoices = line.object_id.invoice_ids.filtered(
            lambda inv: inv.move_type == 'out_invoice' and inv.state == 'posted'
        )
```

### ุฑูุด 3: ุงุฒ `invoice_id` ูุณุชูู
```python
if hasattr(line, 'invoice_id') and line.invoice_id:
    invoice = line.invoice_id
```

ุงู ุฑูฺฉุฑุฏ ุงูุนุทุงูโูพุฐุฑ ุจุงูุง ุฏุงุฑุฏ ู ุจุง ูุณุฎูโูุง ูุฎุชูู ูุงฺูู `commission` ฺฉุงุฑ ูโฺฉูุฏ.

---

## ๐ฆ ูุงุจุณุชฺฏโูุง

- **Odoo Version**: 17.0
- **Dependencies**:
  - `commission` (ูุงฺูู ุงุตู ฺฉูุณูู)

---

## ๐ค ููุณูุฏู

**Ali Payandeh**

- Website: [https://afrand.co.ir](https://afrand.co.ir)
- License: LGPL-3

---

## ๐ ูุณุฎูโูุง

### Version 17.0.1.0.0
- โ ุงุถุงูู ุดุฏู ููุฏูุง `invoice_id` ู `partner_id` ุจู `commission.settlement`
- โ ุงุถุงูู ุดุฏู ููุฏูุง `invoice_id` ู `partner_id` ุจู `commission.settlement.line`
- โ ุงุฌุงุฏ Tree View ู Form View ุจุฑุง ุฎุทูุท ฺฉูุณูู
- โ ุณุงุฒฺฏุงุฑ ุจุง Odoo Studio
- โ ูพุดุชุจุงู ุงุฒ ฺูุฏู ุฑูุด ุจุฑุง ุงูุชู ูุงฺฉุชูุฑ ูุฑุชุจุท

---

## ๐ ุนุจโุงุจ

### ูุดฺฉู: ููุฏูุง ููุงุด ุฏุงุฏู ููโุดููุฏ

**ุฑุงูโุญู:**
1. ูุทูุฆู ุดูุฏ ูุงฺูู ูุตุจ ุดุฏู ุงุณุช
2. Odoo ุฑุง ุฑโุงุณุชุงุฑุช ฺฉูุฏ
3. ุจู **Settings > Technical > User Interface > Views** ุจุฑูุฏ
4. viewูุง `commission.settlement.line` ุฑุง ุจุฑุฑุณ ฺฉูุฏ
5. viewูุง ฺฉู ุงุฒ Studio ุงุฌุงุฏ ุดุฏูโุงูุฏ ู ูุดฺฉู ุฏุงุฑูุฏ ุฑุง ุญุฐู ฺฉูุฏ

### ูุดฺฉู: ุฎุทุง XPath ุฏุฑ Studio

**ุฑุงูโุญู:**
1. viewูุง ูุดฺฉูโุฏุงุฑ Studio ุฑุง ุญุฐู ฺฉูุฏ
2. ูุงฺูู ุฑุง Upgrade ฺฉูุฏ
3. view ุฌุฏุฏ ุจุง priority ุจุงูุง ุฌุงฺฏุฒู ูโุดูุฏ

### ูุดฺฉู: ูุงฺฉุชูุฑ ูุฑุชุจุท ูพุฏุง ููโุดูุฏ

**ุฑุงูโุญู:**
1. ูุทูุฆู ุดูุฏ ฺฉู ุฎุทูุท ุชุณูู ุจู ูุงฺฉุชูุฑ ุง Sale Order ูุฑุชุจุท ูุณุชูุฏ
2. ุจุฑุฑุณ ฺฉูุฏ ฺฉู ูุงฺฉุชูุฑูุง ุฏุฑ ูุถุนุช `posted` ูุณุชูุฏ
3. ุจุฑุฑุณ ฺฉูุฏ ฺฉู ูุงฺฉุชูุฑูุง ุงุฒ ููุน `out_invoice` ูุณุชูุฏ

---

## ๐ Upgrade

ุจุฑุง ุจูโุฑูุฒุฑุณุงู ูุงฺูู:

1. ูุงูโูุง ุฌุฏุฏ ุฑุง ุฌุงฺฏุฒู ฺฉูุฏ
2. Odoo ุฑุง ุฑโุงุณุชุงุฑุช ฺฉูุฏ
3. ุจู **Settings > Apps** ุจุฑูุฏ
4. ูุงฺูู ุฑุง ูพุฏุง ฺฉูุฏ ู ุฑู **Upgrade** ฺฉูฺฉ ฺฉูุฏ

---

## ๐ ูุฌูุฒ

ุงู ูุงฺูู ุชุญุช ูุฌูุฒ **LGPL-3** ููุชุดุฑ ุดุฏู ุงุณุช.

---

## ๐ค ูุดุงุฑฺฉุช

ุงฺฏุฑ ูโุฎูุงูุฏ ุฏุฑ ุชูุณุนู ุงู ูุงฺูู ูุดุงุฑฺฉุช ฺฉูุฏ:

1. Repository ุฑุง Fork ฺฉูุฏ
2. ฺฉ Branch ุฌุฏุฏ ุงุฌุงุฏ ฺฉูุฏ
3. ุชุบุฑุงุช ุฎูุฏ ุฑุง Commit ฺฉูุฏ
4. ฺฉ Pull Request ุงุฑุณุงู ฺฉูุฏ

---

## ๐ ูพุดุชุจุงู

ุจุฑุง ฺฏุฒุงุฑุด ูุดฺฉู ุง ุฏุฑุฎูุงุณุช ูฺฺฏ ุฌุฏุฏุ ูุทูุงู ฺฉ Issue ุฏุฑ Repository ุงุฌุงุฏ ฺฉูุฏ.

---

## โ ฺฺฉโูุณุช ูุตุจ

- [ ] ูุงูโูุง ูุงฺูู ุฏุฑ ูุณุฑ ุตุญุญ ูุฑุงุฑ ฺฏุฑูุชูโุงูุฏ
- [ ] ุฏุณุชุฑุณโูุง ูุงูโูุง ุชูุธู ุดุฏูโุงูุฏ
- [ ] Odoo ุฑโุงุณุชุงุฑุช ุดุฏู ุงุณุช
- [ ] Apps List ุจูโุฑูุฒุฑุณุงู ุดุฏู ุงุณุช
- [ ] ูุงฺูู ูุตุจ ุดุฏู ุงุณุช
- [ ] ููุฏูุง ุฌุฏุฏ ุฏุฑ ูุณุช ุชุณููโูุง ููุงุด ุฏุงุฏู ูโุดููุฏ

---

## ๐ฏ ุงุณุชูุงุฏูโูุง ูพุดุฑูุชู

### ููุชุฑ ฺฉุฑุฏู ุจุฑ ุงุณุงุณ ุฎุฑุฏุงุฑ

ูโุชูุงูุฏ ุงุฒ ููุฏ `partner_id` ุจุฑุง ููุชุฑ ฺฉุฑุฏู ุชุณููโูุง ุจุฑ ุงุณุงุณ ุฎุฑุฏุงุฑ ุงุณุชูุงุฏู ฺฉูุฏ.

### ุฌุณุชุฌู ุฏุฑ ูุงฺฉุชูุฑูุง ูุฑุชุจุท

ุจุง ุงุณุชูุงุฏู ุงุฒ ููุฏ `invoice_id` ูโุชูุงูุฏ ุจู ุฑุงุญุช ุจู ูุงฺฉุชูุฑ ูุฑุชุจุท ุฏุณุชุฑุณ ูพุฏุง ฺฉูุฏ.

---

**ูฺฉุชู**: ุงู ูุงฺูู ุจุง ูุงฺููโูุง ูุฎุชูู `commission` ุณุงุฒฺฏุงุฑ ุงุณุช ู ุงุฒ ุฑูุดโูุง ูุฎุชูู ุจุฑุง ุงูุชู ูุงฺฉุชูุฑ ูุฑุชุจุท ุงุณุชูุงุฏู ูโฺฉูุฏ.

